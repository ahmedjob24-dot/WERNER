<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Maschinen- & Materialverwaltung</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  
  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      background: #f0f2f5;
    }
    .card {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .table thead {
      background-color: #0d6efd;
      color: white;
    }
    .btn-custom {
      background-color: #0d6efd;
      color: white;
      transition: all 0.3s ease;
    }
    .btn-custom:hover {
      background-color: #0b5ed7;
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0,0,0,0.2);
      border-top: 2px solid #0d6efd;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- PRINT RULES --- */
    @media print {
      /* hide everything except print area */
      body * {
        visibility: hidden;
      }
      #printArea, #printArea * {
        visibility: visible;
      }
      #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      /* hide buttons, forms, and the top card */
      .btn, form, .card:first-child, #searchInput {
        display: none !important;
      }
      /* hide Aktionen column completely */
      th:last-child,
      td:last-child {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="text-center mb-4">
      <h1 class="fw-bold text-primary">üè≠ Maschinen- & Material-Tracker</h1>
      <p class="text-muted">Verwalte Maschinen, Standorte, Materialien, St√ºckzahl und Infos.</p>
    </div>

    <!-- Formular -->
    <div class="card p-4 mb-5">
      <h4 class="mb-3 text-secondary">Neue Maschine hinzuf√ºgen</h4>
      <form id="machineForm">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Maschinenname</label>
            <input type="text" id="machineName" class="form-control" placeholder="z. B. CNC-Drehmaschine" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Standort</label>
            <input type="text" id="machineLocation" class="form-control" placeholder="z. B. Werkstatt 2" required />
          </div>
          <div class="col-md-3">
            <label class="form-label">Materialien</label>
            <input type="text" id="machineMaterials" class="form-control" placeholder="z. B. Stahl, Aluminium" required />
          </div>
          <div class="col-md-1">
            <label class="form-label">St√ºcke</label>
            <input type="number" id="machineCount" class="form-control" min="1" value="1" required />
          </div>
          <div class="col-md-2">
            <label class="form-label">Info</label>
            <input type="text" id="machineInfo" class="form-control" placeholder="z. B. Wartung n√∂tig" />
          </div>
        </div>
        <div class="text-end mt-3">
          <button type="submit" class="btn btn-custom px-4" id="submitBtn">
            <span id="submitText">Maschine speichern</span>
            <span id="submitSpinner" class="spinner ms-2" style="display:none;"></span>
          </button>
        </div>
      </form>
    </div>

    <!-- Suchleiste & Druckbutton -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <input type="text" id="searchInput" class="form-control w-50" placeholder="üîç Suche nach Maschine, Standort oder Material..." />
      <button class="btn btn-outline-secondary" onclick="window.print()">üñ®Ô∏è Drucken</button>
    </div>

    <!-- Tabelle -->
    <div class="card p-4" id="printArea">
      <h4 class="text-secondary mb-3">Maschinenliste</h4>
      <div id="tableContainer">
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Maschine</th>
                <th>Standort</th>
                <th>Materialien</th>
                <th>St√ºcke</th>
                <th>Info</th>
                <th>Aktionen</th>
              </tr>
            </thead>
            <tbody id="machineTable">
              <!-- Rows inserted by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal zum Bearbeiten -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Maschine bearbeiten</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editId" />
            <div class="mb-3">
              <label class="form-label">Maschinenname</label>
              <input type="text" id="editName" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Standort</label>
              <input type="text" id="editLocation" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Materialien</label>
              <input type="text" id="editMaterials" class="form-control" required />
            </div>
            <div class="mb-3">
              <label class="form-label">St√ºcke</label>
              <input type="number" id="editCount" class="form-control" min="1" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Info</label>
              <input type="text" id="editInfo" class="form-control" />
            </div>
            <div class="text-end">
              <button type="submit" class="btn btn-custom" id="editSubmitBtn">
                <span>Speichern</span>
                <span class="spinner ms-2" style="display:none;"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap + Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // === SUPABASE SETUP ===
    const SUPABASE_URL = 'https://nxeojbcpvdzzowplbjwq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54ZW9qYmNwdmR6em93cGxiandxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5Nzc3NDEsImV4cCI6MjA3OTU1Mzc0MX0.2hFcua6UkLvIfMm7xz0R9u1DrQ1xCIcVIvC4RY_XEeM'; // üîë REPLACE THIS!
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM Elements
    const machineForm = document.getElementById("machineForm");
    const machineTable = document.getElementById("machineTable");
    const searchInput = document.getElementById("searchInput");
    const submitBtn = document.getElementById("submitBtn");
    const submitText = document.getElementById("submitText");
    const submitSpinner = document.getElementById("submitSpinner");
    const editSubmitBtn = document.getElementById("editSubmitBtn");

    let machines = [];

    // === HELPER: Show/Hide Spinner ===
    function setLoading(button, isLoading) {
      const textSpan = button.querySelector('span:not(.spinner)');
      const spinner = button.querySelector('.spinner');
      if (isLoading) {
        textSpan.style.opacity = '0';
        spinner.style.display = 'inline-block';
        button.disabled = true;
      } else {
        textSpan.style.opacity = '1';
        spinner.style.display = 'none';
        button.disabled = false;
      }
    }

    // === FETCH MACHINES FROM SUPABASE ===
    async function fetchMachines() {
      machineTable.innerHTML = '<tr><td colspan="7" class="text-center">L√§dt...</td></tr>';
      
      const { data, error } = await supabase
        .from('machines')
        .select('*')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Supabase error:', error);
        machineTable.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Fehler beim Laden: ${error.message}</td></tr>`;
        return;
      }

      machines = data || [];
      renderTable();
    }

    // === RENDER TABLE (with optional filter) ===
    function renderTable(filter = "") {
      const filtered = machines.filter(m =>
        (m.name + m.location + (m.materials?.join(", ") || "") + (m.info || ""))
          .toLowerCase()
          .includes(filter.toLowerCase())
      );

      if (filtered.length === 0) {
        machineTable.innerHTML = `<tr><td colspan="7" class="text-center">Keine Maschinen gefunden.</td></tr>`;
        return;
      }

      machineTable.innerHTML = filtered.map((m, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${escapeHtml(m.name)}</td>
          <td>${escapeHtml(m.location)}</td>
          <td>${m.materials?.map(escapeHtml).join(", ") || "-"}</td>
          <td>${m.count}</td>
          <td>${m.info ? escapeHtml(m.info) : "-"}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2" onclick="openEditModal('${m.id}', ${JSON.stringify(m).replace(/'/g, "\\'")})">Bearbeiten</button>
            <button class="btn btn-sm btn-danger" onclick="deleteMachine('${m.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join('');
    }

    // === HTML ESCAPING (security) ===
    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "<")
        .replace(/>/g, ">")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // === ADD MACHINE ===
    machineForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      setLoading(submitBtn, true);

      const name = document.getElementById("machineName").value.trim();
      const location = document.getElementById("machineLocation").value.trim();
      const materialsStr = document.getElementById("machineMaterials").value;
      const materials = materialsStr.split(",").map(m => m.trim()).filter(Boolean);
      const count = parseInt(document.getElementById("machineCount").value);
      const info = document.getElementById("machineInfo").value.trim();

      const { error } = await supabase
        .from('machines')
        .insert([{ name, location, materials, count, info }]);

      setLoading(submitBtn, false);

      if (error) {
        alert("Fehler beim Speichern: " + error.message);
        return;
      }

      machineForm.reset();
      await fetchMachines();
    });

    // === DELETE MACHINE ===
    async function deleteMachine(id) {
      if (!confirm("Diesen Eintrag wirklich l√∂schen?")) return;

      const { error } = await supabase
        .from('machines')
        .delete()
        .eq('id', id);

      if (error) {
        alert("Fehler beim L√∂schen: " + error.message);
        return;
      }

      await fetchMachines();
    }

    // === OPEN EDIT MODAL ===
    function openEditModal(id, machine) {
      document.getElementById("editId").value = id;
      document.getElementById("editName").value = machine.name;
      document.getElementById("editLocation").value = machine.location;
      document.getElementById("editMaterials").value = machine.materials.join(", ");
      document.getElementById("editCount").value = machine.count;
      document.getElementById("editInfo").value = machine.info || "";

      const modal = new bootstrap.Modal(document.getElementById("editModal"));
      modal.show();
    }

    // === UPDATE MACHINE ===
    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const editSubmitBtn = e.submitter || document.getElementById("editSubmitBtn");
      setLoading(editSubmitBtn, true);

      const id = document.getElementById("editId").value;
      const name = document.getElementById("editName").value.trim();
      const location = document.getElementById("editLocation").value.trim();
      const materialsStr = document.getElementById("editMaterials").value;
      const materials = materialsStr.split(",").map(m => m.trim()).filter(Boolean);
      const count = parseInt(document.getElementById("editCount").value);
      const info = document.getElementById("editInfo").value.trim();

      const { error } = await supabase
        .from('machines')
        .update({ name, location, materials, count, info })
        .eq('id', id);

      setLoading(editSubmitBtn, false);

      if (error) {
        alert("Fehler beim Aktualisieren: " + error.message);
        return;
      }

      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
      await fetchMachines();
    });

    // === SEARCH ===
    searchInput.addEventListener("input", (e) => renderTable(e.target.value));

    // === INITIAL LOAD ===
    fetchMachines();
  </script>
</body>
</html>
